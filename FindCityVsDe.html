<!DOCTYPE html>
<html>
<head>
	<title>Linda's World Quiz</title>
	<meta charset="utf-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

	<link rel="stylesheet" href="./dist/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="./dist/leaflet.ie.css" /><![endif]-->

	<style>
		body {
			padding: 0;
			margin: 0;
		}
		html, body, #map {
			height: 100%;
		}
		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255,255,255,0.8);
		}
		.info h4 {
			margin: 5px 5px 5px 5px;
			color: #777;
		}
	</style>
</head>
<body>
	<div id="map"></div>

	<script src="./dist/leaflet.js"></script>
	<script type="text/javascript" src="cities_de.js"></script>
	<script type="text/javascript" src="rand.js"></script>
	<script type="text/javascript">

	var map = L.map('map');
	var countryIdx;
	var resolved = false;
	
	var marker = null;
	var cityMarker = null;
	var line = null;
	var popup = null;
	var OpenStreetMap_Mapnik = null;
	var cnt = 0;
	var borderPoints = [[9.921906,54.983104],[9.93958,54.596642],[10.950112,54.363607],[10.939467,54.008693],[11.956252,54.196486],[12.51844,54.470371],[13.647467,54.075511],[14.119686,53.757029],[14.353315,53.248171],[14.074521,52.981263],[14.4376,52.62485],[14.685026,52.089947],[14.607098,51.745188],[15.016996,51.106674],[14.570718,51.002339],[14.307013,51.117268],[14.056228,50.926918],[13.338132,50.733234],[12.966837,50.484076],[12.240111,50.266338],[12.415191,49.969121],[12.521024,49.547415],[13.031329,49.307068],[13.595946,48.877172],[13.243357,48.416115],[12.884103,48.289146],[13.025851,47.637584],[12.932627,47.467646],[12.62076,47.672388],[12.141357,47.703083],[11.426414,47.523766],[10.544504,47.566399],[10.402084,47.302488],[9.896068,47.580197],[9.594226,47.525058],[8.522612,47.830828],[8.317301,47.61358],[7.466759,47.620582],[7.593676,48.333019],[8.099279,49.017784],[6.65823,49.201958],[6.18632,49.463803],[6.242751,49.902226],[6.043073,50.128052],[6.156658,50.803721],[5.988658,51.851616],[6.589397,51.852029],[6.84287,52.22844],[7.092053,53.144043],[6.90514,53.482162],[7.100425,53.693932],[7.936239,53.748296],[8.121706,53.527792],[8.800734,54.020786],[8.572118,54.395646],[8.526229,54.962744],[9.282049,54.830865],[9.921906,54.983104]];
	for(var i = 0; i < borderPoints.length; i++) {
		var tmp = borderPoints[i][0]; borderPoints[i][0] = borderPoints[i][1]; borderPoints[i][1] = tmp;
		}
	var xx = L.polyline(borderPoints);
	xx.addTo(map);
	
	if(get("id"))
		randomize(get("id"));
	else
		randomize(Date());		
	
	var shuffleArray = new Array();
	for(var i = 0; i < statesData.features.length; i++) {
		shuffleArray[i] = i;
	}
	shuffle(shuffleArray);
	
	map.on('click', setMarker);
	var Esri_WorldShadedRelief = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
		attribution: '&copy; <a href="http://www.esri.com/software/arcgis/arcgis-online-map-and-geoservices/map-services">Esri</a>',
		noWrap: true, maxZoom: 13
	});
	Esri_WorldShadedRelief.addTo(map);	
	
	// control that shows state info on hover
	var info = L.control();

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info leaflet-bar');
		L.DomEvent.addListener(this._div, 'click', function (e) {
		L.DomEvent.stopPropagation(e);
		});
		return this._div;
	};				

	info.update = function () {		
		var headerText = "Finde die Stadt";
		var resolveText = "Aufl&ouml;sen";
		var nextText = "Weiter";
			
		var html = '' + headerText + '<div style="text-align: center"><h4>' + getLocalizedFeatureName(statesData.features[countryIdx]) + '</h4></div>';		
		html = html + '<div style="text-align: right">';
			
		if(resolved) 					
			html = html + '<input type="button" value="' + nextText + '" onclick="nextCountry()">';
		else
			html = html + '<input type="button" value="' + resolveText + '" onclick="resolve()">';
				
		html = html + '</div>';
			
		this._div.innerHTML = html;
	};
	info.addTo(map);
						
	updateMap();	
				
	nextCountry();
	
function get(name){
   if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
      return decodeURIComponent(name[1]);
}

	function setMarker(e) {
		if(resolved)
			return
	
		if(marker) 
			marker.setLatLng(e.latlng);
 		else {
			marker = L.marker(e.latlng, {draggable: true, clickable:false, opacity: .5});
			marker.on('drag', onDragging);
			marker.addTo(map);
		}
	}
	
	function onDragging(e) {
    //map.invalidateSize()
    marker.setLatLng(e.target.getLatLng());
	}
			
	function nextCountry() {				
		countryIdx = shuffleArray[cnt++ % shuffleArray.length];
		if(marker) {
			map.removeLayer(marker);
			marker = null;
		}
		if(cityMarker) {
			map.removeLayer(cityMarker);
			cityMarker = null;
		}
		if(line) {
			map.removeLayer(line);
			line = null;
		}
		if(popup) {
			map.removeLayer(popup);
			popup = null;
		}
		if(OpenStreetMap_Mapnik) {
			map.removeLayer(OpenStreetMap_Mapnik);
			OpenStreetMap_Mapnik = null;
		}
		
		map.setView([51, 10], 5);

		resolved = false;
		updateUI();
	}
	
	function latLngToPtvMercator(latlng)
    {
		return new L.Point(
			6371000.0 * latlng.lng * Math.PI / 180,
			6371000.0 * Math.log(Math.tan(Math.PI / 4 + latlng.lat * Math.PI / 360)));
    }
	
	function ptvMercatorToLatLng(point)
    {
		return new L.LatLng(
			(360 / Math.PI) * (Math.atan(Math.exp(point.y / 6371000.0)) - (Math.PI / 4)),
			(180.0 / Math.PI) * (point.x / 6371000.0));
 	}
		
	function resolve() {			
		OpenStreetMap_Mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { noWrap: true, opacity: .5,
			attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
		});
   	    OpenStreetMap_Mapnik.addTo(map);

		var lnglat = statesData.features[countryIdx].geometry.coordinates;
		var latlng = new L.LatLng(lnglat[1], lnglat[0]);
		cityMarker = L.marker(latlng, {draggable: false, clickable:false, opacity: .5,
					 icon:new L.Icon.Default({iconUrl:"dist/images/marker-green.png", iconRetinaUrl:"dist/images/marker-green-2x.png"})});
		cityMarker.addTo(map);

		if(marker) {
			var p1 = latLngToPtvMercator(latlng);
			var p2 = latLngToPtvMercator(marker.getLatLng());
			var c = ptvMercatorToLatLng(new L.Point((p1.x+p2.x) / 2, (p1.y+p2.y) / 2));
		
			// mercator distance
			var mercDist = Math.sqrt((p2.x-p1.x)*(p2.x-p1.x) + (p2.y-p1.y)*(p2.y-p1.y));
      
			// real distance
			var realDist = .001 * mercDist * Math.cos(latlng.lat * Math.PI / 180.0);

			line = new L.Polyline([latlng, marker.getLatLng()]);
			line.addTo(map);

			popup = L.popup()
				.setLatLng(c)
				.setContent('' + Math.round(realDist) + ' km');

			map.fitBounds(new L.LatLngBounds([latlng, marker.getLatLng()]).pad(.5));
				
			popup.openOn(map);

				}
				
		else {
			map.setView(latlng, 10);
		}
		resolved = true;
		updateUI();
	}
		
	function updateUI() {
		info.update();
	}
				
	function getLocalizedFeatureName(feature) {
			return feature.id;
	}

	function updateMap() {		
	}
		
	map.attributionControl.addAttribution('<a href="https://github.com/oliverheilig/LindasWorldQuiz">Linda&#8216;s World Quiz</a>');
	map.attributionControl.addAttribution('<a href="https://github.com/mahemoff/geodata">mahemoff/geodata</a>');

	</script>
</body>
</html>

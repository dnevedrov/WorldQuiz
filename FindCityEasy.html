<!DOCTYPE html>
<html>
<head>
	<title>Linda's World Quiz</title>
	<meta charset="utf-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

	<link rel="stylesheet" href="./dist/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="./dist/leaflet.ie.css" /><![endif]-->

	<style>
		body {
			padding: 0;
			margin: 0;
		}
		html, body, #map {
			height: 100%;
		}
		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255,255,255,0.8);
		}
		.info h4 {
			margin: 5px 5px 5px 5px;
			color: #777;
		}
	</style>
</head>
<body>
	<div id="map"></div>

	<script src="./dist/leaflet.js"></script>
	<script type="text/javascript" src="cities.js"></script>
//	<script type="text/javascript" src="cities_de.js"></script>
	<script type="text/javascript">

	var map = L.map('map');
	var countryIdx;
	var resolved = false;
	var highlightedFeature;
	var lang = (navigator.language) ? navigator.language : navigator.userLanguage; 	
	if(lang)
		lang=lang.substr(0,2).toLowerCase();
	var geojson;		
	var jsonToFeature;
	var namesLookUp;		

	var OpenStreetMap_Mapnik = null;		
	var Esri_WorldShadedRelief = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
		attribution: '&copy; <a href="http://www.esri.com/software/arcgis/arcgis-online-map-and-geoservices/map-services">Esri</a>',
		maxZoom: 13
	});
	Esri_WorldShadedRelief.addTo(map);	

	// control that shows state info on hover
	var info = L.control();

	info.onAdd = function (map) {
	this._div = L.DomUtil.create('div', 'info leaflet-bar');
		return this._div;
	};				

	info.update = function () {		
		var headerText = "Find the country";
		var resolveText = "Solve";
		var nextText = "Next";
			
		if(lang == "de") {
			headerText = "Finde das Land";
			resolveText = "Aufl&ouml;sen";
			nextText = "Weiter";
		}
			
		var html = '' + headerText + '<div style="text-align: center"><h4>' + getLocalizedFeatureName(statesData.features[countryIdx]) + '</h4></div>';		
		html = html + '<div style="text-align: right">';
			
		if(resolved) 					
			html = html + '<input type="button" value="' + nextText + '" onclick="nextCountry()">';
		else
			html = html + '<input type="button" value="' + resolveText + '" onclick="resolve()">';
				
		html = html + '</div>';
			
		this._div.innerHTML = html;
	};
	info.addTo(map);
		
	// control that toggles the language
	var langSelect = L.control({position:"bottomleft"});

	langSelect.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'leaflet-bar');
		return this._div;
	};				

	langSelect.update = function () {		
		if(lang == "de")
			this._div.innerHTML = '<input type="button" value="EN" onclick="toggleLanguage()">';
		else
			this._div.innerHTML = '<input type="button" value="DE" onclick="toggleLanguage()">';
	};
	langSelect.addTo(map);
	
	
	initLanguage();
		
	updateMap();	
				
	nextCountry();

	
	function initLanguage(id) {
		if(lang == "de") {
			namesLookUp = {};
			for (var i = 0, len = names_de.length; i < len; i++) 
				namesLookUp[names_de[i].id] = names_de[i];
		}
		else 
			namesLookUp = undefined;
	}
	
	function checkResult(id) {
		if(id == statesData.features[countryIdx].id)
			resolve();
		else {
			var feature = jsonToFeature[id];
			highlightFeature(feature, '#faa');
		}
	}
		
	function nextCountry() {
		if(OpenStreetMap_Mapnik) {
			map.removeLayer(OpenStreetMap_Mapnik);
			OpenStreetMap_Mapnik = null;
		}
		if(highlightedFeature) 
			geojson.resetStyle(highlightedFeature);
				
		countryIdx = Math.floor(Math.random() * statesData.features.length);
		map.fitWorld();

		resolved = false;
		updateUI();
	}
		
	function resolve() {
			OpenStreetMap_Mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 	opacity: .5,
			attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
		});
   	    OpenStreetMap_Mapnik.addTo(map);

		var feature = jsonToFeature[statesData.features[countryIdx].id];

		highlightFeature(feature, '#afa');
		
		map.setView([statesData.features[countryIdx].geometry.coordinates[1],
		statesData.features[countryIdx].geometry.coordinates[0]], 8);

		resolved = true;
		updateUI();
	}
		
	function updateUI() {
		info.update();
		langSelect.update();
	}
		
	function toggleLanguage() {
		if(lang == "de")
			lang = "en";
		else 
			lang = "de";
				
		initLanguage();	
		updateMapLanguage();	
		updateUI();
	}
		
	function updateMapLanguage() {
		for (var i = 0, len = statesData.features.length; i < len; i++) {
			var layer = jsonToFeature[statesData.features[i].id];
			layer.bindPopup(getLocalizedFeatureName(statesData.features[i]));
		}
	}
		
	function style(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 1.0,
			fillColor: '#00f'
		};
	}
		
	function highlightFeature(layer, c) {
		if(highlightedFeature)
			geojson.resetStyle(highlightedFeature);

		highlightedFeature = layer;

//		layer.bringToFront();
	}

	function zoomToFeature(e) {
		var layer = e.target;
		checkResult(layer.feature.id);
	}

	function onEachFeature(feature, layer) {
		jsonToFeature[feature.id] = layer;

		layer.on({
			click: zoomToFeature
		});
	}		
		
	function getLocalizedFeatureName(feature) {
		if(namesLookUp && namesLookUp[feature.id])
			return namesLookUp[feature.id].name;
		else
			return feature.id;
	}

	function updateMap() {		
		jsonToFeature = {};
			
		if(geojson)
			map.removeLayer(geojson);
				
		geojson = L.geoJson(statesData, {
			style: style,
			onEachFeature: onEachFeature
		}).addTo(map);

		updateMapLanguage();
	}
		
	map.attributionControl.addAttribution('<a href="https://github.com/oliverheilig/LindasWorldQuiz">Linda&#8216;s World Quiz</a>');
	map.attributionControl.addAttribution('<a href="https://github.com/johan/world.geo.json">world.geo.json</a>');

	</script>
</body>
</html>
